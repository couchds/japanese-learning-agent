generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model dictionary_entries {
  id                       Int                        @id @default(autoincrement())
  entry_id                 Int                        @unique
  created_at               DateTime?                  @default(now()) @db.Timestamp(6)
  updated_at               DateTime?                  @default(now()) @db.Timestamp(6)
  entry_kanji              entry_kanji[]
  entry_readings           entry_readings[]
  entry_senses             entry_senses[]
  resource_words           resource_words[]
  pronunciation_recordings pronunciation_recordings[]
}

model entry_cross_references {
  id           Int          @id @default(autoincrement())
  sense_id     Int
  xref_text    String
  xref_type    String?      @db.VarChar(50)
  entry_senses entry_senses @relation(fields: [sense_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model entry_kanji {
  id                     Int                      @id @default(autoincrement())
  entry_id               Int
  kanji                  String
  is_common              Boolean?                 @default(false)
  priority_tags          String[]
  info                   String[]
  kanji_order            Int
  dictionary_entries     dictionary_entries       @relation(fields: [entry_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  entry_kanji_characters entry_kanji_characters[]

  @@unique([entry_id, kanji_order])
  @@index([is_common], map: "idx_entry_kanji_common")
  @@index([entry_id], map: "idx_entry_kanji_entry_id")
  @@index([kanji], map: "idx_entry_kanji_kanji")
}

model entry_kanji_characters {
  id             Int         @id @default(autoincrement())
  entry_kanji_id Int
  kanji_id       Int
  position       Int
  entry_kanji    entry_kanji @relation(fields: [entry_kanji_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  kanji          kanji       @relation(fields: [kanji_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([entry_kanji_id, position])
  @@index([entry_kanji_id], map: "idx_entry_kanji_characters_entry_kanji_id")
  @@index([kanji_id], map: "idx_entry_kanji_characters_kanji_id")
}

model entry_readings {
  id                 Int                @id @default(autoincrement())
  entry_id           Int
  reading            String
  is_common          Boolean?           @default(false)
  priority_tags      String[]
  info               String[]
  reading_order      Int
  dictionary_entries dictionary_entries @relation(fields: [entry_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([entry_id, reading_order])
  @@index([is_common], map: "idx_entry_readings_common")
  @@index([entry_id], map: "idx_entry_readings_entry_id")
  @@index([reading], map: "idx_entry_readings_reading")
}

model entry_senses {
  id                     Int                      @id @default(autoincrement())
  entry_id               Int
  sense_order            Int
  parts_of_speech        String[]
  fields                 String[]
  misc                   String[]
  dialects               String[]
  entry_cross_references entry_cross_references[]
  dictionary_entries     dictionary_entries       @relation(fields: [entry_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sense_glosses          sense_glosses[]

  @@unique([entry_id, sense_order])
  @@index([entry_id], map: "idx_entry_senses_entry_id")
  @@index([parts_of_speech], map: "idx_entry_senses_pos", type: Gin)
}

model kanji {
  id                     Int                      @id @default(autoincrement())
  literal                String                   @unique @db.VarChar(10)
  unicode_codepoint      String?                  @db.VarChar(10)
  classical_radical      Int?
  stroke_count           Int
  grade                  Int?
  frequency_rank         Int?
  jlpt_level             Int?
  on_readings            String[]
  kun_readings           String[]
  nanori_readings        String[]
  created_at             DateTime?                @default(now()) @db.Timestamp(6)
  updated_at             DateTime?                @default(now()) @db.Timestamp(6)
  entry_kanji_characters entry_kanji_characters[]
  kanji_meanings         kanji_meanings[]
  resource_kanji         resource_kanji[]

  @@index([frequency_rank], map: "idx_kanji_frequency")
  @@index([grade], map: "idx_kanji_grade")
  @@index([jlpt_level], map: "idx_kanji_jlpt")
  @@index([literal], map: "idx_kanji_literal")
  @@index([classical_radical], map: "idx_kanji_radical")
  @@index([stroke_count], map: "idx_kanji_stroke_count")
  @@index([unicode_codepoint], map: "idx_kanji_unicode")
}

model kanji_meanings {
  id            Int    @id @default(autoincrement())
  kanji_id      Int
  meaning       String
  meaning_order Int
  kanji         kanji  @relation(fields: [kanji_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([kanji_id, meaning_order])
  @@index([kanji_id], map: "idx_kanji_meanings_kanji_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model resources {
  id               Int                @id @default(autoincrement())
  user_id          Int
  name             String             @db.VarChar(500)
  type             String             @db.VarChar(50)
  status           String             @default("not_started") @db.VarChar(50)
  description      String?
  image_path       String?            @db.VarChar(1000)
  difficulty_level String?            @db.VarChar(50)
  tags             String[]
  created_at       DateTime?          @default(now()) @db.Timestamp(6)
  updated_at       DateTime?          @default(now()) @db.Timestamp(6)
  users            users              @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  resource_kanji   resource_kanji[]
  resource_words   resource_words[]
  custom_vocabulary custom_vocabulary[]
  resource_images  resource_images[]

  @@index([difficulty_level], map: "idx_resources_difficulty")
  @@index([status], map: "idx_resources_status")
  @@index([tags], map: "idx_resources_tags", type: Gin)
  @@index([type], map: "idx_resources_type")
  @@index([user_id], map: "idx_resources_user_id")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model sense_glosses {
  id           Int          @id @default(autoincrement())
  sense_id     Int
  gloss        String
  gloss_type   String?      @db.VarChar(50)
  gloss_order  Int
  entry_senses entry_senses @relation(fields: [sense_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([sense_id, gloss_order])
  @@index([sense_id], map: "idx_sense_glosses_sense_id")
}

model users {
  id                        Int                         @id @default(autoincrement())
  username                  String                      @unique @db.VarChar(255)
  email                     String                      @unique @db.VarChar(255)
  password_hash             String                      @db.VarChar(255)
  email_verified            Boolean                     @default(false)
  verification_token        String?                     @db.VarChar(255)
  verification_token_expiry DateTime?                   @db.Timestamp(6)
  twofa_enabled             Boolean                     @default(false)
  created_at                DateTime?                   @default(now()) @db.Timestamp(6)
  updated_at                DateTime?                   @default(now()) @db.Timestamp(6)
  resources                 resources[]
  pronunciation_recordings  pronunciation_recordings[]
  twofa_codes               twofa_codes[]
  resource_images           resource_images[]
  user_knowledge            user_knowledge[]

  @@index([email], map: "idx_users_email")
  @@index([username], map: "idx_users_username")
  @@index([verification_token], map: "idx_users_verification_token")
}

model resource_kanji {
  id          Int       @id @default(autoincrement())
  resource_id Int
  kanji_id    Int
  frequency   Int       @default(0)
  notes       String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  updated_at  DateTime? @default(now()) @db.Timestamp(6)
  resources   resources @relation(fields: [resource_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  kanji       kanji     @relation(fields: [kanji_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([resource_id, kanji_id])
  @@index([resource_id], map: "idx_resource_kanji_resource_id")
  @@index([kanji_id], map: "idx_resource_kanji_kanji_id")
}

model resource_words {
  id                 Int                @id @default(autoincrement())
  resource_id        Int
  entry_id           Int
  frequency          Int                @default(0)
  notes              String?
  created_at         DateTime?          @default(now()) @db.Timestamp(6)
  updated_at         DateTime?          @default(now()) @db.Timestamp(6)
  resources          resources          @relation(fields: [resource_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  dictionary_entries dictionary_entries @relation(fields: [entry_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([resource_id, entry_id])
  @@index([resource_id], map: "idx_resource_words_resource_id")
  @@index([entry_id], map: "idx_resource_words_entry_id")
}

model custom_vocabulary {
  id          Int       @id @default(autoincrement())
  resource_id Int
  word        String    @db.VarChar(255)
  reading     String?   @db.VarChar(255)
  meaning     String?
  frequency   Int       @default(0)
  notes       String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  updated_at  DateTime? @default(now()) @db.Timestamp(6)
  resources   resources @relation(fields: [resource_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([resource_id, word])
  @@index([resource_id], map: "idx_custom_vocabulary_resource_id")
}

model pronunciation_recordings {
  id                 Int                @id @default(autoincrement())
  user_id            Int
  entry_id           Int
  audio_path         String             @db.VarChar(1000)
  is_reference       Boolean            @default(false)
  duration_ms        Int?
  notes              String?
  created_at         DateTime?          @default(now()) @db.Timestamp(6)
  updated_at         DateTime?          @default(now()) @db.Timestamp(6)
  users              users              @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  dictionary_entries dictionary_entries @relation(fields: [entry_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_pronunciation_recordings_user_id")
  @@index([entry_id], map: "idx_pronunciation_recordings_entry_id")
  @@index([is_reference], map: "idx_pronunciation_recordings_is_reference")
}

model twofa_codes {
  id         Int       @id @default(autoincrement())
  user_id    Int
  code       String    @db.VarChar(10)
  expires_at DateTime  @db.Timestamp(6)
  used       Boolean   @default(false)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_twofa_codes_user_id")
  @@index([code], map: "idx_twofa_codes_code")
  @@index([expires_at], map: "idx_twofa_codes_expires_at")
}

model resource_images {
  id            Int            @id @default(autoincrement())
  resource_id   Int
  user_id       Int
  image_path    String         @db.VarChar(1000)
  notes         String?
  ocr_processed Boolean        @default(false)
  ocr_raw_text  String?        @db.Text // Full raw OCR output for reference
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  resources     resources      @relation(fields: [resource_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users         users          @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ocr_elements  ocr_elements[]

  @@index([resource_id], map: "idx_resource_images_resource_id")
  @@index([user_id], map: "idx_resource_images_user_id")
  @@index([created_at], map: "idx_resource_images_created_at")
  @@index([ocr_processed], map: "idx_resource_images_ocr_processed")
}

model ocr_elements {
  id               Int             @id @default(autoincrement())
  resource_image_id Int
  text             String          @db.VarChar(500) // The recognized text
  element_type     String          @db.VarChar(50) // 'kanji', 'vocabulary', 'hiragana', 'katakana', 'unknown'
  item_id          Int?            // References kanji.id, dictionary_entries.id, etc. (null if not matched)
  confidence       Float?          // OCR confidence score (0.0-1.0)
  position_x       Int?            // Bounding box coordinates (optional)
  position_y       Int?
  width            Int?
  height           Int?
  created_at       DateTime?       @default(now()) @db.Timestamp(6)
  resource_images  resource_images @relation(fields: [resource_image_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([resource_image_id], map: "idx_ocr_elements_image_id")
  @@index([element_type, item_id], map: "idx_ocr_elements_type_item")
  @@index([text], map: "idx_ocr_elements_text")
}

model user_knowledge {
  id                Int       @id @default(autoincrement())
  user_id           Int
  item_type         String    @db.VarChar(50) // 'kanji', 'vocabulary', 'grammar', 'hiragana', 'katakana', etc.
  item_id           Int       // ID of the item (kanji_id, entry_id, etc.)
  proficiency_level Int       @default(0) // 0-5: 0=unknown, 1=learning, 2=familiar, 3=known, 4=mastered, 5=native
  review_count      Int       @default(0)
  correct_count     Int       @default(0)
  incorrect_count   Int       @default(0)
  last_reviewed     DateTime? @db.Timestamp(6)
  next_review       DateTime? @db.Timestamp(6) // For SRS
  notes             String?
  created_at        DateTime? @default(now()) @db.Timestamp(6)
  updated_at        DateTime? @default(now()) @db.Timestamp(6)
  users             users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, item_type, item_id], map: "unique_user_item")
  @@index([user_id], map: "idx_user_knowledge_user_id")
  @@index([item_type, item_id], map: "idx_user_knowledge_item")
  @@index([proficiency_level], map: "idx_user_knowledge_proficiency")
  @@index([next_review], map: "idx_user_knowledge_next_review")
}
